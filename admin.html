<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .order {
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: red;
            background: #ffe6e6;
            border-radius: 8px;
        }
        .btn {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
        <button class="btn" onclick="loadOrders()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <div id="orders-container">
            <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAis4G-tc2NkT9nrn4VpB39mDVqPILqTpA",
            authDomain: "saroo5-ab72a.firebaseapp.com",
            projectId: "saroo5-ab72a",
            storageBucket: "saroo5-ab72a.firebasestorage.app",
            messagingSenderId: "265152576253",
            appId: "1:265152576253:web:38d3104acc701b3fd19c94",
            measurementId: "G-HC4G1LQSEY"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log('âœ… Firebase initialized successfully');
        } catch (error) {
            console.error('âŒ Firebase initialization error:', error);
            showError('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase: ' + error.message);
        }

        const db = firebase.firestore();

        // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ HTML Ø¶Ø¯ XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        async function loadOrders() {
            const container = document.getElementById('orders-container');
            container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>';
            
            try {
                console.log('ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...');
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                const snapshot = await db.collection('orders').get();
                
                const orders = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const createdAt = data.createdAt ? 
                        (data.createdAt.toDate ? new Date(data.createdAt.toDate()) : new Date(data.createdAt)) : 
                        null;
                    
                    orders.push({
                        id: doc.id,
                        name: data.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³Ù…
                        phone: data.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        details: data.details || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„',
                        address: data.address || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†ÙˆØ§Ù†',
                        status: data.status || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                        createdAt: createdAt ? createdAt.toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                        timestamp: createdAt ? createdAt.getTime() : 0
                    });
                });
                
                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
                orders.sort((a, b) => b.timestamp - a.timestamp);
                
                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', orders);
                displayOrders(orders);
                
            } catch (error) {
                console.error('âŒ Error loading orders:', error);
                showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ' + error.message);
            }
        }

        function displayOrders(orders) {
            const container = document.getElementById('orders-container');
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="loading">ğŸ‰ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
                return;
            }

            let html = '';
            orders.forEach(order => {
                // ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¶Ø¯ XSS
                const safeId = escapeHtml(order.id);
                const safePhone = escapeHtml(order.phone);
                const safeDetails = escapeHtml(order.details);
                const safeAddress = escapeHtml(order.address);
                const safeStatus = escapeHtml(order.status);
                const safeCreatedAt = escapeHtml(order.createdAt);
                
                                        // <h3>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${safeId.substring(0, 8)}</h3>

                html += `
                    <div class="order">
                        <h3>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${escapeHtml(order.phone)}</h3>
                        <p><strong>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:</strong> ${escapeHtml(order.name)}</p>  <!-- â† Ø§Ù„Ø§Ø³Ù… -->
                        <p><strong>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${safePhone}</p>
                        <p><strong>ğŸ“¦ Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${safeDetails}</p>
                        <p><strong>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${safeAddress}</p>
                        <p><strong>ğŸ”„ Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span style="color: ${getStatusColor(order.status)}; font-weight: bold;">${safeStatus}</span></p>
                        <p><strong>ğŸ•’ ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> ${safeCreatedAt}</p>
                        <div style="margin-top: 15px;">
                            <button class="btn" style="background: #27ae60;" onclick="updateStatus('${safeId}', 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²')">â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</button>
                            <button class="btn" style="background: #f39c12;" onclick="updateStatus('${safeId}', 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚')">ğŸšš ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</button>
                            <button class="btn" style="background: #27ae60;" onclick="updateStatus('${safeId}', 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„')">âœ… ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</button>
                            <button class="btn" style="background: #e74c3c;" onclick="rejectOrder('${safeId}')">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showError(message) {
            const container = document.getElementById('orders-container');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        function getStatusColor(status) {
            if (status.includes('ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„')) return '#27ae60';
            if (status.includes('ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚')) return '#f39c12';
            if (status.includes('Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²')) return '#3498db';
            if (status.includes('Ø¬Ø¯ÙŠØ¯')) return '#95a5a6';
            if (status.includes('Ù…Ù„ØºÙŠ')) return '#e74c3c';
            return '#333';
        }

        async function updateStatus(orderId, newStatus) {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰: ${newStatus}ØŸ`)) {
                try {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© "ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„"ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
                    if (newStatus === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') {
                        await db.collection('orders').doc(orderId).delete();
                        alert(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­`);
                    } else {
                        // ØºÙŠØ± Ø°Ù„ÙƒØŒ Ø­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙ‚Ø·
                        await db.collection('orders').doc(orderId).update({
                            status: newStatus
                        });
                        alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ "${newStatus}"`);
                    }
                    loadOrders();
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨: ' + error.message);
                    console.error('Error updating order:', error);
                }
            }
        }

        async function rejectOrder(orderId) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ ÙˆØ­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
                try {
                    // Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    await db.collection('orders').doc(orderId).delete();
                    alert('âŒ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                    loadOrders();
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨: ' + error.message);
                    console.error('Error deleting order:', error);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
</body>
</html>